<!--
    belaUI - web UI for the BELABOX project
    Copyright (C) 2020-2021 BELABOX project

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <link rel="stylesheet" href="/bootstrap.min.css" />
    <link rel="stylesheet" href="/jquery-ui-1.12.1.css" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="container mt-4" style="max-width: 700px">

      <div class="alert alert-danger alert-dismissible show" role="alert" id="errorMsg">
        <span></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div> <!-- .alert -->

      <div class="mb-4">
        <button type="button" id="startStop" class="btn btn-lg btn-block mb-2">
          Start
        </button>

        <div class="form-group">
          <input type="text" id="bitrateValues" class="slider-values form-control" readonly/>
          <div id="bitrateSlider" class="slider mt-2"></div>
        </div>
      </div> <!-- .mb-4 -->

      <table class="table mb-4">
        <thead>
          <tr>
            <th scope="col">Port</th>
            <th scope="col">IP</th>
            <th scope="col" class="col-6">Bitrate</th>
          </tr>
        </thead>
        <tbody id="modems"></tbody>
      </table>
	  
	  <canvas id="myChart" width="400" height="400"></canvas>
	  
	  <table class="table mb-4">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Name</th>
            <th scope="col" class="col-6">Temperature</th>
          </tr>
        </thead>
        <tbody id="temps"></tbody>
      </table>

      <div id="settings">
        <div class="card mb-2">
          <div class="card-header bg-success text-center" type="button"
               data-toggle="collapse" data-target="#collapseOne">
            <button class="btn btn-link text-white" type="button" data-toggle="collapse"
                    data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
              Encoder settings
            </button>
          </div> <!-- card-header -->

          <div class="collapse" id="collapseOne">
            <div class="card-body">
              <div class="form-group">
                <select class="custom-select" name="pipelines" id="pipelines"></select>
              </div>
              <div id="delay" class="form-group">
                <input type="text" id="delayValue" class="slider-values form-control" readonly/>
                <div id="delaySlider" class="slider mt-2"></div>
              </div>
            </div> <!-- .card-body -->
          </div> <!-- .collapse -->
        </div> <!-- .card -->

        <div class="card mb-2">
          <div class="card-header bg-success text-center" type="button"
               data-toggle="collapse" data-target="#collapseTwo">
            <button class="btn btn-link text-white" type="button" data-toggle="collapse"
              data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              SRTLA settings
            </button>
          </div> <!-- .card-header -->

          <div class="collapse" id="collapseTwo">
            <div class="card-body">
              <div class="form-group">
                <label for="srtlaAddr">SRTLA receiver address</label>
                <input type="text" class="form-control" id="srtlaAddr" />
              </div>
              <div class="form-group">
                <label for="srtlaPort">SRTLA receiver port</label>
                <input type="text" class="form-control" id="srtlaPort" />
              </div>
              <div class="form-group">
                <label for="srtStreamid">SRT streamid</label>
                <input type="text" class="form-control" id="srtStreamid" />
              </div>
              <div class="form-group">
                <input type="text" id="srtLatencyValue" class="slider-values form-control" readonly/>
                <div id="srtLatencySlider" class="slider mt-2"></div>
              </div>
            </div> <!-- .card-body -->
          </div> <!-- .collapse -->
        </div> <!-- .card -->

        <div class="card mb-2">
          <div class="card-header bg-success text-center" type="button"
               data-toggle="collapse" data-target="#collapseThree">
            <button class="btn btn-link text-white" type="button" data-toggle="collapse"
                    data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
              System
            </button>
          </div> <!-- card-header -->

          <div class="collapse" id="collapseThree">
            <div class="card-body">
              <button type="button" id="poweroff" class="btn btn-block btn-danger command-btn">
                Power off
              </button>
              <button type="button" id="reboot" class="btn btn-block btn-danger command-btn">
                Restart
              </button>
            </div> <!-- .card-body -->
          </div> <!-- .collapse -->
        </div> <!-- .card -->

      </div> <!-- #settings -->
    </div> <!-- .container -->

    <div class="overlay" id="overlayBG"></div>
    <div class="overlay" id="overlayText">
      <p></p>
      <button type="button" id="refreshBtn" class="btn btn-lg btn-light">Refresh</button>
    </div>

    <script type="text/javascript" src="/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="/jquery-ui-1.12.1.js"></script>
    <script type="text/javascript" src="/jquery.ui.touch-punch.js"></script>
    <script type="text/javascript" src="/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="/script.js"></script>
	<script type="text/javascript" src="/chart.min.js"></script>
	<script>
	function getRandomInt(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
	}

	const DATA_COUNT = 12;
	const labels = [];
	for (let i = 0; i < DATA_COUNT; ++i) {
	  labels.push(i.toString());
	}
	const data = {
	  labels: labels,
	  datasets: []
	};
	
	let last_modem;
	
	$.getJSON("/modems", function(data) {
		console.log(data);
		data.forEach((item, index) => {
			let txb = 0;
			//R1=item.rxb
			//T1=item.txb
			//sleep 1
			//R2=item.rxb
			//T2=item.txb
			//tot=(( (R2 + T2 - R1 - T1) / 1024 ))
			myChart.data.datasets[index] = {
				label: `${item.i} (${item.ip})`,
				backgroundColor: `rgb(0, ${getRandomInt(0,255)}, ${getRandomInt(0,255)})`,
				borderColor: `rgb(0, ${getRandomInt(0,255)}, ${getRandomInt(0,255)})`,
				data: [txb],
			  };
		 });
		myChart.update(); 
		last_modem = data;
	});

	const config = {
	  type: 'line',
	  data: data,
	  options: {
		responsive: true,
		plugins: {
		  legend: {
			position: 'bottom',
		  },
		  title: {
			display: true,
			text: 'Bitrate Graph by m_o_o_'
		  }
		},
		scales: {
		  x: {
			display: true,
			title: {
			  display: true
			}
		  },
		  y: {
			display: true,
			title: {
			  display: true,
			  text: 'Kbps'
			},
			suggestedMin: 0,
			suggestedMax: 6000
		  }
		}
	  },
	};

	var myChart = new Chart(
		document.getElementById('myChart'),
		config
	  );
	  
	  setInterval(function(){
		$.getJSON("/modems", function(data) {
			data.forEach((item, index) => {
			let txb = 0;
			if (last_modem && index in last_modem && "txb" in last_modem[index] && "rxb" in last_modem[index]) {
			  txb = item.txb - prev_modems[index].txb;
			  txb = Math.round((txb * 8) / 1024);
			}
			if(myChart.data.datasets[index].data.length >= DATA_COUNT)
			{
				myChart.data.datasets[index].data.shift();
			}
			myChart.data.datasets[index].data.push(txb);
		 });
		myChart.update(); 
		last_modem = data;
		});
	}, 1000);

	</script>
  </body>
</html>
